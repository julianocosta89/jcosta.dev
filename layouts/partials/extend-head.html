{{/* Consent Banner Styles */}}
<style>
  /* Dark mode (default) */
  .consent-banner {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(10px);
    color: #fff;
    padding: 1.5rem;
    z-index: 9999;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    transform: translateY(100%);
    transition: transform 0.3s ease-out;
  }

  .consent-banner.show {
    transform: translateY(0);
  }

  /* Light mode - when dark class is NOT present on html */
  html:not(.dark) .consent-banner {
    background: rgba(255, 255, 255, 0.95);
    color: #1f2937;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  html:not(.dark) .consent-banner-text a {
    color: #2563eb;
  }

  html:not(.dark) .consent-banner-btn-decline {
    color: #6b7280;
    border-color: #d1d5db;
  }

  html:not(.dark) .consent-banner-btn-decline:hover {
    background: rgba(0, 0, 0, 0.05);
    color: #1f2937;
  }

  .consent-banner-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .consent-banner-text {
    flex: 1;
    min-width: 250px;
  }

  .consent-banner-text p {
    margin: 0;
    font-size: 0.95rem;
    line-height: 1.5;
  }

  .consent-banner-text a {
    color: #3b82f6;
    text-decoration: underline;
  }

  .consent-banner-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .consent-banner-btn {
    padding: 0.625rem 1.25rem;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 500;
    transition: all 0.2s;
  }

  .consent-banner-btn-accept {
    background: #3b82f6;
    color: white;
  }

  .consent-banner-btn-accept:hover {
    background: #2563eb;
  }

  .consent-banner-btn-decline {
    background: transparent;
    color: #9ca3af;
    border: 1px solid #4b5563;
  }

  .consent-banner-btn-decline:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #fff;
  }

  @media (max-width: 768px) {
    .consent-banner-content {
      flex-direction: column;
      align-items: stretch;
    }

    .consent-banner-buttons {
      width: 100%;
    }

    .consent-banner-btn {
      flex: 1;
    }
  }
</style>

{{/* Consent Management and Conditional Datadog RUM Initialization */}}
<script>
  (function() {
    const CONSENT_KEY = 'jcosta-analytics-consent';
    const CONSENT_VERSION = '1';
    const CONSENT_EXPIRY_MONTHS = 6;

    // Function to load and initialize Datadog RUM
    function loadDatadogRUM() {
      // Check if script is already loaded
      if (document.querySelector('script[src*="datadog-rum"]')) {
        initDatadogRUM();
        return;
      }

      const script = document.createElement('script');
      script.src = 'https://www.datadoghq-browser-agent.com/eu1/v6/datadog-rum.js';
      script.type = 'text/javascript';
      script.onload = function() {
        initDatadogRUM();
      };
      script.onerror = function() {
        console.error('Failed to load Datadog RUM script');
      };
      document.head.appendChild(script);
    }

    // Function to initialize Datadog RUM
    function initDatadogRUM() {
      if (window.DD_RUM) {
        window.DD_RUM.init({
          clientToken: 'pubab09ff8a7fee0682485eec0e2f2034cc',
          applicationId: 'b6d9da4a-109a-4a3d-b34c-9db935401a61',
          site: 'datadoghq.eu',
          service: 'jcosta.dev',
          env: 'prod',
          sessionSampleRate: 100,
          sessionReplaySampleRate: 10,
          trackBfcacheViews: true,
          defaultPrivacyLevel: 'mask-user-input',
        });
      }
    }

    // Check for existing consent with expiry
    function getConsent() {
      try {
        const stored = localStorage.getItem(CONSENT_KEY);
        if (stored) {
          const data = JSON.parse(stored);
          const expiryDate = new Date();
          expiryDate.setMonth(expiryDate.getMonth() - CONSENT_EXPIRY_MONTHS);

          if (data.version === CONSENT_VERSION && new Date(data.timestamp) > expiryDate) {
            return data.consent;
          }
          // Consent expired, remove it
          localStorage.removeItem(CONSENT_KEY);
        }
      } catch (e) {
        console.error('Error reading consent:', e);
      }
      return null;
    }

    // Save consent choice
    function saveConsent(accepted) {
      try {
        localStorage.setItem(CONSENT_KEY, JSON.stringify({
          consent: accepted,
          version: CONSENT_VERSION,
          timestamp: new Date().toISOString()
        }));
      } catch (e) {
        console.error('Error saving consent:', e);
      }
    }

    // Show consent banner with focus management
    function showBanner() {
      const banner = document.getElementById('consent-banner');
      if (banner) {
        banner.classList.add('show');

        // Focus the accept button after animation completes
        setTimeout(function() {
          const acceptBtn = document.getElementById('consent-accept');
          if (acceptBtn) {
            acceptBtn.focus();
          }
        }, 300);

        // Trap focus within the banner
        trapFocus(banner);
      }
    }

    // Hide consent banner
    function hideBanner() {
      const banner = document.getElementById('consent-banner');
      if (banner) {
        banner.classList.remove('show');
      }
    }

    // Trap focus within modal for accessibility
    function trapFocus(element) {
      const focusableElements = element.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      const firstFocusable = focusableElements[0];
      const lastFocusable = focusableElements[focusableElements.length - 1];

      element.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
          if (e.shiftKey) {
            if (document.activeElement === firstFocusable) {
              lastFocusable.focus();
              e.preventDefault();
            }
          } else {
            if (document.activeElement === lastFocusable) {
              firstFocusable.focus();
              e.preventDefault();
            }
          }
        }

        // Close on Escape key
        if (e.key === 'Escape') {
          handleConsent(false);
        }
      });
    }

    // Handle user choice
    function handleConsent(accepted) {
      saveConsent(accepted);
      hideBanner();

      if (accepted) {
        loadDatadogRUM();
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      const consent = getConsent();

      if (consent === true) {
        loadDatadogRUM();
      } else if (consent === null) {
        showBanner();
      }

      // Attach event listeners
      const acceptBtn = document.getElementById('consent-accept');
      const declineBtn = document.getElementById('consent-decline');

      if (acceptBtn) {
        acceptBtn.addEventListener('click', function() {
          handleConsent(true);
        });
      }

      if (declineBtn) {
        declineBtn.addEventListener('click', function() {
          handleConsent(false);
        });
      }
    });
  })();
</script>
